--// SERVICES
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

--// CONFIG
local BOX_COLOR = Color3.fromRGB(170, 0, 255)
local HIGHLIGHT_OUTLINE = Color3.fromRGB(0, 170, 255)
local HIGHLIGHT_FILL = Color3.fromRGB(0, 60, 255)
local SCAN_INTERVAL = 0.5

--// STATE
local settings = {
    espEnabled = true,
    nameESP = true,
    teamCheck = true
}

local playersFolder = Workspace:FindFirstChild("Players") or Workspace:WaitForChild("Players", 10)
local highlighted = {}
local boxes = {}
local nameTags = {}
local healthBars = {}
local distanceLabels = {}
local connections = {}
local scriptRunning = true
local myCharacterName = nil
local menuVisible = true

--// UI CREATION
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NovaOpsGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

--// MAIN FRAME
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 420, 0, 580)
MainFrame.Position = UDim2.new(0.5, -210, 0.5, -290)
MainFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 14)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(255, 145, 40)
MainStroke.Thickness = 2
MainStroke.Parent = MainFrame

--// HEADER
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 60)
Header.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
Header.BorderSizePixel = 0
Header.Parent = MainFrame

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 12)
HeaderCorner.Parent = Header

local HeaderAccent = Instance.new("Frame")
HeaderAccent.Size = UDim2.new(1, 0, 0, 3)
HeaderAccent.Position = UDim2.new(0, 0, 1, -3)
HeaderAccent.BackgroundColor3 = Color3.fromRGB(255, 145, 40)
HeaderAccent.BorderSizePixel = 0
HeaderAccent.Parent = Header

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -40, 0, 30)
Title.Position = UDim2.new(0, 20, 0, 8)
Title.BackgroundTransparency = 1
Title.Text = "NovaOps-Services"
Title.TextColor3 = Color3.fromRGB(255, 145, 40)
Title.TextSize = 22
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Header

local Subtitle = Instance.new("TextLabel")
Subtitle.Size = UDim2.new(1, -40, 0, 20)
Subtitle.Position = UDim2.new(0, 20, 0, 35)
Subtitle.BackgroundTransparency = 1
Subtitle.Text = "Lone Survival"
Subtitle.TextColor3 = Color3.fromRGB(150, 150, 150)
Subtitle.TextSize = 14
Subtitle.Font = Enum.Font.Gotham
Subtitle.TextXAlignment = Enum.TextXAlignment.Left
Subtitle.Parent = Header

--// CONTENT AREA
local Content = Instance.new("ScrollingFrame")
Content.Size = UDim2.new(1, -30, 1, -105)
Content.Position = UDim2.new(0, 15, 0, 75)
Content.BackgroundTransparency = 1
Content.BorderSizePixel = 0
Content.ScrollBarThickness = 6
Content.ScrollBarImageColor3 = Color3.fromRGB(255, 145, 40)
Content.CanvasSize = UDim2.new(0, 0, 0, 700)
Content.Parent = MainFrame

--// CLEANUP FUNCTION
local function cleanupPlayer(model)
    if highlighted[model] then
        local hl = model:FindFirstChild("PlayerGlow")
        if hl then 
            pcall(function() hl:Destroy() end)
        end
        highlighted[model] = nil
    end
    
    if boxes[model] then
        for _, line in ipairs(boxes[model]) do
            pcall(function() line:Destroy() end)
        end
        local hrp = model:FindFirstChild("HumanoidRootPart")
        if hrp then
            local folder = hrp:FindFirstChild("ESPBoxFolder")
            if folder then
                pcall(function() folder:Destroy() end)
            end
        end
        boxes[model] = nil
    end
    
    if nameTags[model] then
        if nameTags[model][1] then
            pcall(function() nameTags[model][1]:Destroy() end)
        end
        nameTags[model] = nil
    end
    
    if healthBars[model] then
        if healthBars[model][1] then
            pcall(function() healthBars[model][1]:Destroy() end)
        end
        healthBars[model] = nil
    end
    
    if distanceLabels[model] then
        if distanceLabels[model][1] then
            pcall(function() distanceLabels[model][1]:Destroy() end)
        end
        distanceLabels[model] = nil
    end
end

--// SECTION CREATOR
local yOffset = 0
local function createSection(title)
    local section = Instance.new("Frame")
    section.Size = UDim2.new(1, 0, 0, 40)
    section.Position = UDim2.new(0, 0, 0, yOffset)
    section.BackgroundTransparency = 1
    section.Parent = Content
    
    local sectionTitle = Instance.new("TextLabel")
    sectionTitle.Size = UDim2.new(1, 0, 1, 0)
    sectionTitle.BackgroundTransparency = 1
    sectionTitle.Text = "// " .. title
    sectionTitle.TextColor3 = Color3.fromRGB(255, 145, 40)
    sectionTitle.TextSize = 16
    sectionTitle.Font = Enum.Font.GothamBold
    sectionTitle.TextXAlignment = Enum.TextXAlignment.Left
    sectionTitle.Parent = section
    
    local line = Instance.new("Frame")
    line.Size = UDim2.new(1, 0, 0, 1)
    line.Position = UDim2.new(0, 0, 1, -1)
    line.BackgroundColor3 = Color3.fromRGB(255, 145, 40)
    line.BorderSizePixel = 0
    line.BackgroundTransparency = 0.5
    line.Parent = section
    
    yOffset = yOffset + 45
end

--// TOGGLE CREATOR
local function createToggle(text, defaultState, callback)
    local toggle = Instance.new("Frame")
    toggle.Size = UDim2.new(1, 0, 0, 45)
    toggle.Position = UDim2.new(0, 0, 0, yOffset)
    toggle.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
    toggle.BorderSizePixel = 0
    toggle.Parent = Content
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 8)
    toggleCorner.Parent = toggle
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -60, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = toggle
    
    local switchBack = Instance.new("Frame")
    switchBack.Size = UDim2.new(0, 50, 0, 26)
    switchBack.Position = UDim2.new(1, -60, 0.5, -13)
    switchBack.BackgroundColor3 = defaultState and Color3.fromRGB(255, 145, 40) or Color3.fromRGB(40, 40, 45)
    switchBack.BorderSizePixel = 0
    switchBack.Parent = toggle
    
    local switchCorner = Instance.new("UICorner")
    switchCorner.CornerRadius = UDim.new(1, 0)
    switchCorner.Parent = switchBack
    
    local switchButton = Instance.new("Frame")
    switchButton.Size = UDim2.new(0, 22, 0, 22)
    switchButton.Position = defaultState and UDim2.new(1, -24, 0.5, -11) or UDim2.new(0, 2, 0.5, -11)
    switchButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    switchButton.BorderSizePixel = 0
    switchButton.Parent = switchBack
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(1, 0)
    buttonCorner.Parent = switchButton
    
    local clickDetector = Instance.new("TextButton")
    clickDetector.Size = UDim2.new(1, 0, 1, 0)
    clickDetector.BackgroundTransparency = 1
    clickDetector.Text = ""
    clickDetector.Parent = toggle
    
    clickDetector.MouseButton1Click:Connect(function()
        defaultState = not defaultState
        switchBack.BackgroundColor3 = defaultState and Color3.fromRGB(255, 145, 40) or Color3.fromRGB(40, 40, 45)
        switchButton:TweenPosition(
            defaultState and UDim2.new(1, -24, 0.5, -11) or UDim2.new(0, 2, 0.5, -11),
            Enum.EasingDirection.Out,
            Enum.EasingStyle.Quad,
            0.2,
            true
        )
        callback(defaultState)
    end)
    
    yOffset = yOffset + 50
end

--// SLIDER CREATOR
local function createSlider(text, min, max, defaultVal, callback)
    local slider = Instance.new("Frame")
    slider.Size = UDim2.new(1, 0, 0, 65)
    slider.Position = UDim2.new(0, 0, 0, yOffset)
    slider.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
    slider.BorderSizePixel = 0
    slider.Parent = Content
    
    local sliderCorner = Instance.new("UICorner")
    sliderCorner.CornerRadius = UDim.new(0, 8)
    sliderCorner.Parent = slider
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -90, 0, 25)
    label.Position = UDim2.new(0, 15, 0, 10)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = slider
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Size = UDim2.new(0, 70, 0, 25)
    valueLabel.Position = UDim2.new(1, -80, 0, 10)
    valueLabel.BackgroundTransparency = 1
    valueLabel.Text = tostring(defaultVal)
    valueLabel.TextColor3 = Color3.fromRGB(255, 145, 40)
    valueLabel.TextSize = 14
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.TextXAlignment = Enum.TextXAlignment.Right
    valueLabel.Parent = slider
    
    local sliderBack = Instance.new("Frame")
    sliderBack.Size = UDim2.new(1, -30, 0, 6)
    sliderBack.Position = UDim2.new(0, 15, 1, -20)
    sliderBack.BackgroundColor3 = Color3.fromRGB(26, 26, 32)
    sliderBack.BorderSizePixel = 0
    sliderBack.Parent = slider
    
    local backCorner = Instance.new("UICorner")
    backCorner.CornerRadius = UDim.new(1, 0)
    backCorner.Parent = sliderBack
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((defaultVal - min) / (max - min), 0, 1, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(255, 145, 40)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBack
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(1, 0)
    fillCorner.Parent = sliderFill
    
    local sliderButton = Instance.new("TextButton")
    sliderButton.Size = UDim2.new(1, 0, 1, 0)
    sliderButton.BackgroundTransparency = 1
    sliderButton.Text = ""
    sliderButton.Parent = sliderBack
    
    local dragging = false
    sliderButton.MouseButton1Down:Connect(function() dragging = true end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePos = UserInputService:GetMouseLocation()
            local sliderPos = sliderBack.AbsolutePosition.X
            local sliderSize = sliderBack.AbsoluteSize.X
            local relativePos = math.clamp(mousePos.X - sliderPos, 0, sliderSize)
            local percentage = relativePos / sliderSize
            local value = math.floor(min + (percentage * (max - min)))
            sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
            valueLabel.Text = tostring(value)
            callback(value)
        end
    end)
    
    yOffset = yOffset + 70
end

--// BUILD UI
createSection("ESP SETTINGS")
createToggle("Enable ESP", true, function(state)
    settings.espEnabled = state
    if not state then
        for model in pairs(highlighted) do
            cleanupPlayer(model)
        end
    end
end)

createToggle("Name Tags", true, function(state)
    settings.nameESP = state
    if not state then
        for model, tagData in pairs(nameTags) do
            if tagData[1] then tagData[1]:Destroy() end
        end
        nameTags = {}
    else
        for _, model in pairs(playersFolder:GetChildren()) do
            if model:IsA("Model") and highlighted[model] then
                createNameTag(model)
            end
        end
    end
end)

createToggle("Team Check", true, function(state)
    settings.teamCheck = state
    for model in pairs(highlighted) do
        cleanupPlayer(model)
    end
end)

--// FOOTER
local Footer = Instance.new("Frame")
Footer.Size = UDim2.new(1, 0, 0, 35)
Footer.Position = UDim2.new(0, 0, 1, -35)
Footer.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
Footer.BorderSizePixel = 0
Footer.Parent = MainFrame

local FooterCorner = Instance.new("UICorner")
FooterCorner.CornerRadius = UDim.new(0, 12)
FooterCorner.Parent = Footer

local FooterText = Instance.new("TextLabel")
FooterText.Size = UDim2.new(1, 0, 1, 0)
FooterText.BackgroundTransparency = 1
FooterText.Text = "If you Paid for this You got Scammed LOL!"
FooterText.TextColor3 = Color3.fromRGB(150, 150, 150)
FooterText.TextSize = 12
FooterText.Font = Enum.Font.GothamBold
FooterText.Parent = Footer

--// TOGGLE MENU VISIBILITY
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Insert then
        menuVisible = not menuVisible
        MainFrame.Visible = menuVisible
    end
end)

--// DRAGGABLE UI
local dragging, dragInput, dragStart, startPos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
    end
end)

Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

--// FUNCTIONS
local function updateMyCharacter()
    local cam = Workspace.CurrentCamera
    if cam and cam.CameraSubject and cam.CameraSubject.Parent then
        myCharacterName = cam.CameraSubject.Parent.Name
    end
end

local function isOnSameTeam(model)
    if not settings.teamCheck then return false end
    local myChar = LocalPlayer.Character
    if not myChar then return false end
    local myTeam = myChar:FindFirstChild("TeamColor")
    local theirTeam = model:FindFirstChild("TeamColor")
    if myTeam and theirTeam then
        return myTeam.Value == theirTeam.Value
    end
    return false
end

local function createNameTag(model)
    if not settings.nameESP then return end
    if nameTags[model] then return end
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPNameTag"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 150, 0, 30)
    billboard.StudsOffset = Vector3.new(0, 4, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 500
    billboard.Parent = hrp
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = model.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextSize = 13
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextStrokeTransparency = 0.5
    nameLabel.TextScaled = false
    nameLabel.Parent = billboard
    
    nameTags[model] = {billboard}
end

local function createHealthBar(model)
    if healthBars[model] then return end
    local hrp = model:FindFirstChild("HumanoidRootPart")
    local hum = model:FindFirstChildOfClass("Humanoid")
    if not hrp or not hum then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPHealthBar"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 100, 0, 25)
    billboard.StudsOffset = Vector3.new(0, 5, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 500
    billboard.Parent = hrp
    
    local healthText = Instance.new("TextLabel")
    healthText.Size = UDim2.new(1, 0, 1, 0)
    healthText.BackgroundTransparency = 1
    healthText.Text = "❤️ " .. math.floor(hum.Health)
    healthText.TextColor3 = Color3.fromRGB(255, 255, 255)
    healthText.TextSize = 14
    healthText.Font = Enum.Font.GothamBold
    healthText.TextStrokeTransparency = 0.5
    healthText.TextScaled = false
    healthText.Parent = billboard
    
    healthBars[model] = {billboard, healthText, hum}
    
    hum:GetPropertyChangedSignal("Health"):Connect(function()
        if not healthBars[model] then return end
        local health = math.floor(hum.Health)
        healthText.Text = "❤️ " .. health
        
        local percentage = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
        if percentage > 0.66 then
            healthText.TextColor3 = Color3.fromRGB(0, 255, 0)
        elseif percentage > 0.33 then
            healthText.TextColor3 = Color3.fromRGB(255, 255, 0)
        else
            healthText.TextColor3 = Color3.fromRGB(255, 0, 0)
        end
    end)
end

local function createDistanceLabel(model)
    if distanceLabels[model] then return end
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPDistanceLabel"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 70, 0, 20)
    billboard.StudsOffset = Vector3.new(0, -3.5, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 500
    billboard.Parent = hrp
    
    local distanceText = Instance.new("TextLabel")
    distanceText.Size = UDim2.new(1, 0, 1, 0)
    distanceText.BackgroundTransparency = 1
    distanceText.Text = "0m"
    distanceText.TextColor3 = Color3.fromRGB(255, 255, 255)
    distanceText.TextSize = 12
    distanceText.Font = Enum.Font.GothamBold
    distanceText.TextStrokeTransparency = 0.5
    distanceText.TextScaled = false
    distanceText.Parent = billboard
    
    distanceLabels[model] = {billboard, distanceText, hrp}
end

local distanceCounter = 0
local function updateDistances()
    distanceCounter = distanceCounter + 1
    if distanceCounter % 5 ~= 0 then return end
    local myChar = LocalPlayer.Character
    if not myChar then return end
    local myHRP = myChar:FindFirstChild("HumanoidRootPart")
    if not myHRP then return end
    
    for model, data in pairs(distanceLabels) do
        if data[1] and data[2] and data[3] then
            local distance = (myHRP.Position - data[3].Position).Magnitude
            data[2].Text = math.floor(distance) .. "m"
        end
    end
end

local function createBox(model)
    if not settings.espEnabled then return end
    if boxes[model] then return end
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local folder = Instance.new("Folder")
    folder.Name = "ESPBoxFolder"
    folder.Parent = hrp
    
    local team = isOnSameTeam(model)
    local boxColor = team and Color3.fromRGB(255, 145, 40) or Color3.fromRGB(255, 0, 0)
    
    local boxSize = Vector3.new(4, 6, 4)
    local lineThickness = 0.1
    local halfSize = boxSize / 2
    
    local boxCorners = {
        Vector3.new(-halfSize.X, halfSize.Y, -halfSize.Z),
        Vector3.new(halfSize.X, halfSize.Y, -halfSize.Z),
        Vector3.new(halfSize.X, halfSize.Y, halfSize.Z),
        Vector3.new(-halfSize.X, halfSize.Y, halfSize.Z),
        Vector3.new(-halfSize.X, -halfSize.Y, -halfSize.Z),
        Vector3.new(halfSize.X, -halfSize.Y, -halfSize.Z),
        Vector3.new(halfSize.X, -halfSize.Y, halfSize.Z),
        Vector3.new(-halfSize.X, -halfSize.Y, halfSize.Z)
    }
    
    local function makeLine(pointA, pointB)
        local distance = (pointA - pointB).Magnitude
        local midpoint = (pointA + pointB) / 2
        local boxLine = Instance.new("BoxHandleAdornment")
        boxLine.Adornee = hrp
        boxLine.Size = Vector3.new(lineThickness, lineThickness, distance)
        boxLine.CFrame = CFrame.new(midpoint, pointB)
        boxLine.Color3 = boxColor
        boxLine.Transparency = 0
        boxLine.AlwaysOnTop = true
        boxLine.ZIndex = 10
        boxLine.Parent = folder
        return boxLine
    end
    
    local allLines = {
        makeLine(boxCorners[1], boxCorners[2]),
        makeLine(boxCorners[2], boxCorners[3]),
        makeLine(boxCorners[3], boxCorners[4]),
        makeLine(boxCorners[4], boxCorners[1]),
        makeLine(boxCorners[5], boxCorners[6]),
        makeLine(boxCorners[6], boxCorners[7]),
        makeLine(boxCorners[7], boxCorners[8]),
        makeLine(boxCorners[8], boxCorners[5]),
        makeLine(boxCorners[1], boxCorners[5]),
        makeLine(boxCorners[2], boxCorners[6]),
        makeLine(boxCorners[3], boxCorners[7]),
        makeLine(boxCorners[4], boxCorners[8])
    }
    boxes[model] = allLines
end

local function createHighlight(model)
    if not settings.espEnabled then return end
    if highlighted[model] then return end
    if model.Name == myCharacterName then return end
    if isOnSameTeam(model) then return end
    
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local hum = model:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then return end
    
    local team = isOnSameTeam(model)
    local outlineColor = team and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(255, 0, 0)
    local fillColor = team and Color3.fromRGB(255, 145, 40) or Color3.fromRGB(255, 0, 0)
    
    local hl = Instance.new("Highlight")
    hl.Name = "PlayerGlow"
    hl.FillTransparency = 0.75
    hl.FillColor = fillColor
    hl.OutlineColor = outlineColor
    hl.OutlineTransparency = 0
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = model
    
    highlighted[model] = true
    createBox(model)
    createNameTag(model)
    createHealthBar(model)
    createDistanceLabel(model)
    
    hum.Died:Connect(function()
        cleanupPlayer(model)
    end)
end

--// MAIN LOOP
table.insert(connections, RunService.RenderStepped:Connect(function()
    local camera = Workspace.CurrentCamera
    local viewport = camera.ViewportSize
    updateDistances()
end))

--// SCAN FUNCTION
local function scanPlayers()
    if not settings.espEnabled then return end
    updateMyCharacter()
    
    for _, model in ipairs(playersFolder:GetChildren()) do
        if model:IsA("Model") and not highlighted[model] then
            createHighlight(model)
        end
    end
end

--// INITIAL SCAN
scanPlayers()

--// NEW PLAYERS
table.insert(connections, playersFolder.ChildAdded:Connect(function(child)
    if not child:IsA("Model") then return end
    
    local hrp = child:WaitForChild("HumanoidRootPart", 5)
    if not hrp then return end
    
    createHighlight(child)
    
    task.delay(0.5, function()
        if scriptRunning and settings.espEnabled then
            createHighlight(child)
        end
    end)
end))

--// PLAYER REMOVAL
table.insert(connections, playersFolder.ChildRemoved:Connect(function(child)
    if child:IsA("Model") then
        cleanupPlayer(child)
    end
end))

--// MAIN LOOP
task.spawn(function()
    while scriptRunning do
        if settings.espEnabled then
            scanPlayers()
        end
        task.wait(SCAN_INTERVAL)
    end
end)